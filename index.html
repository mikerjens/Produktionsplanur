<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRENKARIRNIR · Produktionsportal & Call Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    mark { padding: .1rem .2rem; border-radius: .25rem; }
    @media print {
      .no-print { display:none !important; }
      .print-break { page-break-before: always; }
      body { background:white; }
      .card { box-shadow:none !important; border:1px solid #e5e7eb; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="no-print sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">KR</div>
        <div>
          <h1 class="text-xl font-bold">KRENKARIRNIR · Produktionsportal</h1>
          <p class="text-sm text-slate-500">Mødetider, lokationer, kontaktbog & call sheets</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="printTodayBtn" class="no-print inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-medium hover:bg-slate-800">Print: Dagens call sheet</button>
        <button id="printAllBtn" class="no-print inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white border text-sm font-medium hover:bg-slate-50">Print: Alle call sheets</button>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="no-print max-w-6xl mx-auto px-4 mt-6">
    <div class="grid md:grid-cols-5 gap-3">
      <div class="md:col-span-2">
        <label class="block text-xs font-semibold text-slate-600 mb-1">Søg (navn, rolle, location)</label>
        <input id="searchInput" type="text" placeholder="Skriv f.eks. 'Hotel Føroyar' eller 'Make-up'" class="w-full px-3 py-2 rounded-xl border bg-white" />
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Filtrér på måned</label>
        <select id="monthFilter" class="w-full px-3 py-2 rounded-xl border bg-white">
          <option value="">Alle</option>
          <option value="09">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Spring til dato</label>
        <select id="jumpTo" class="w-full px-3 py-2 rounded-xl border bg-white"></select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Vis planer for person</label>
        <select id="personFilter" class="w-full px-3 py-2 rounded-xl border bg-white">
          <option value="">Alle personer</option>
        </select>
      </div>
    </div>
    <p id="personHint" class="no-print mt-2 text-xs text-slate-600 hidden">Filtret viser kun de dage hvor <span class="font-semibold"></span> er nævnt. De relevante tider er fremhævet.</p>
  </section>

  <!-- Schedule list -->
  <main id="daysContainer" class="max-w-6xl mx-auto px-4 py-6 space-y-6"></main>

  <!-- Kontaktbog (global) -->
  <section id="rolodex" class="max-w-6xl mx-auto px-4 pb-16">
    <hr class="my-8"/>
    <h2 class="text-lg font-semibold mb-2">Kontaktbog · Alle navne</h2>
    <p class="text-sm text-slate-600 mb-4">Alfabetisk liste (uden telefon og e-mail).</p>
    <div id="rolodexGrid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
  </section>

<script>
// ====== DATA (redigér her) ======
const scheduleData = [
  {
    id: "2025-09-23",
    dateISO: "2025-09-23",
    dateLabel: "Tirsdag 23. sept.",
    title: "Flashback 1A – SIRKUS",
    location: { name: "Sirkus bar", address: "Tórshavn", map: "https://maps.google.com/?q=Sirkus+T%C3%B3rshavn" },
    calltimes: [
      { time: "16:00", group: "Teknisk crew", notes: "Gør scenen klar (HPH, Thomas, Jónfinn)" },
      { time: "18:15", group: "Skuespillere", notes: "Make-up & kostume (Marius DC, Hanna F., Sóley, Súsanna) – spis inden ankomst" },
      { time: "19:30", group: "ALLE", notes: "Optagelse starter" },
      { time: "21:00", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør", name: "Thomas Koba" },
      { role: "Foto", name: "Jónfinn Stenberg" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Make-up", name: "Julia Jacobsen" },
      { role: "Location", name: "Sunneva H. Eysturstein (SIRKUS)" }
    ],
    scenes: ["Bar-scene: Danny føler på kvinde i baren (Sirkus)"]
  },
  {
    id: "2025-10-07",
    dateISO: "2025-10-07",
    dateLabel: "Tirsdag 7. okt.",
    title: "Flashback 2 – Festen med Líggjas",
    location: { name: "Hvarvið 3, kj.", address: "Tórshavn", map: "https://maps.google.com/?q=Hvarvi%C3%B0+3+T%C3%B3rshavn" },
    calltimes: [
      { time: "14:00", group: "Crew", notes: "Gør scenen klar (HPH, Thomas, Michael, Anna K., Ronni)" },
      { time: "15:15", group: "Skuespillere", notes: "Til make-up i Hugskotið; transport til location" },
      { time: "16:30", group: "ALLE", notes: "Optagelse start på location" },
      { time: "19:00", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør + foto", name: "Thomas Koba" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Lyd", name: "Ronni Poulsen" },
      { role: "Make-up", name: "Julia Jacobsen" },
      { role: "Location", name: "Petur Háberg" }
    ],
    scenes: ["Ball i køkkenet · Montage · Líggjas VO · Líggjas føler på Lív"]
  },
  {
    id: "2025-10-17",
    dateISO: "2025-10-17",
    dateLabel: "Fredag 17. okt.",
    title: "Klargøring – Terapilokale",
    location: { name: "Aulan, Studentaskúlin í Hoydølum", map: "https://maps.google.com/?q=Studentask%C3%BAlin+%C3%AD+Hoyd%C3%B8lum" },
    calltimes: [
      { time: "11:00–18:00", group: "Lys + Instr.", notes: "Opsætning (HPH, Thomas)" },
      { time: "11:00–16:00", group: "Props/Design", notes: "Klargøring (Anna Kristin)" },
      { time: "16:00–18:00", group: "Foto + Lyd", notes: "Møder (Jónfinn, Høgni)" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør", name: "Thomas Koba" },
      { role: "Foto", name: "Jónfinn Stenberg" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Lyd", name: "Høgni Fagraberg" }
    ],
    scenes: ["Opsætning af terapilokale – ingen optagelser"]
  },
  {
    id: "2025-10-19",
    dateISO: "2025-10-19",
    dateLabel: "Søndag 19. okt.",
    title: "Flashback 4 – Ruth flirter med tjener",
    location: { name: "Hotel Brandan – Rest. Húsagarður & køkken", map: "https://maps.google.com/?q=Hotel+Brandan+T%C3%B3rshavn" },
    calltimes: [
      { time: "14:00", group: "Lys/Instr./Prod.", notes: "Opsætning (HPH, Thomas, Michael)" },
      { time: "14:45", group: "Props/Design", notes: "Møder" },
      { time: "15:00", group: "Skuespillere + Make-up", notes: "Elsa Maria, Tórur, Jaspur; Julia møder" },
      { time: "15:30", group: "ALLE", notes: "Optagelse starter" },
      { time: "18:30", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør/foto", name: "Thomas Koba" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Make-up", name: "Julia Jacobsen" }
    ],
    scenes: ["Ruth flirter med tjeneren"]
  },
  {
    id: "2025-11-01",
    dateISO: "2025-11-01",
    dateLabel: "Lørdag 1. nov.",
    title: "Optagelse i terapilokale (Dag 1)",
    location: { name: "Aulan, Studentaskúlin í Hoydølum", map: "https://maps.google.com/?q=Studentask%C3%BAlin+%C3%AD+Hoyd%C3%B8lum" },
    calltimes: [
      { time: "06:00", group: "Crew + (Bjørn, Marius)", notes: "Make-up/kostume; Props møder (Anna K.)" },
      { time: "06:30", group: "Hjálmar & Elsa", notes: "Make-up/kostume" },
      { time: "07:00", group: "Esther & Hans", notes: "Make-up/kostume" },
      { time: "07:01", group: "ALLE", notes: "Morgenmad (kaffe/te & rundstykker)" },
      { time: "08:00", group: "ALLE", notes: "Optagelse starter" },
      { time: "10:30", group: "ALLE", notes: "Pause/kaffe" },
      { time: "12:30", group: "ALLE", notes: "Frokost (gryderet fra Jan)" },
      { time: "13:15", group: "ALLE", notes: "Optagelse fortsætter" },
      { time: "15:30", group: "ALLE", notes: "Pause/kaffe" },
      { time: "15:45", group: "ALLE", notes: "Optagelse fortsætter" },
      { time: "19:00", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør", name: "Thomas Koba" },
      { role: "Foto", name: "Jónfinn Stenberg" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Lyd", name: "Høgni Fagraberg" },
      { role: "Make-up", name: "Julia Jacobsen" }
    ],
    scenes: ["Terapisessioner (1-4): se manus-noter"]
  },
  {
    id: "2025-11-02",
    dateISO: "2025-11-02",
    dateLabel: "Søndag 2. nov.",
    title: "Optagelse i terapilokale (Dag 2)",
    location: { name: "Aulan, Studentaskúlin í Hoydølum" },
    calltimes: [ { time: "06:00", group: "Plan som 1. nov.", notes: "Detaljer følger samme struktur" } ],
    contacts: [],
    scenes: ["Forts. terapisessioner"]
  },
  {
    id: "2025-11-03",
    dateISO: "2025-11-03",
    dateLabel: "Mandag 3. nov.",
    title: "Flashback 1B – Dannys flirt",
    location: { name: "Studio 016, Hotel Føroyar", map: "https://maps.google.com/?q=Hotel+F%C3%B8royar" },
    calltimes: [
      { time: "16:00", group: "Teknisk crew", notes: "Opsætning (HPH, Thomas, Jónfinn, Anna K., Ronni)" },
      { time: "17:30", group: "Skuespillere", notes: "Make-up & kostume (Marius DC, Hanna F.)" },
      { time: "18:15", group: "ALLE", notes: "Optagelse starter" },
      { time: "19:30", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør", name: "Thomas Koba" },
      { role: "Foto", name: "Jónfinn Stenberg" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Lyd", name: "Ronni Poulsen" },
      { role: "Make-up", name: "Julia Jacobsen" },
      { role: "Location", name: "Hotel Føroyar – Rósa Maria Restorff" }
    ],
    scenes: ["Hotelværelse: Danny & kvinde"]
  },
  {
    id: "2025-11-05",
    dateISO: "2025-11-05",
    dateLabel: "Onsdag 5. nov.",
    title: "Esther hjemme-scene",
    location: { name: "Dr. Dahlsgøta 15, Tórshavn" },
    calltimes: [
      { time: "14:00", group: "Crew", notes: "HPH, Thomas, Ronni" },
      { time: "15:15", group: "Skuespillere", notes: "Páll Oddur, Esther" },
      { time: "16:15", group: "Make-up", notes: "Julia (fri efter make-up)" },
      { time: "16:15", group: "ALLE", notes: "Optagelse starter" },
      { time: "19:30", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [
      { role: "Producer", name: "Michael Koba" },
      { role: "Instruktør/foto", name: "Thomas Koba" },
      { role: "Lys", name: "Hans Petur Hansen" },
      { role: "Props/Design", name: "Anna Kristin Bæk" },
      { role: "Lyd", name: "Ronni Poulsen" },
      { role: "Make-up", name: "Julia Jacobsen" },
      { role: "Location", name: "Katrin Kallsberg" }
    ],
    scenes: ["Soveværelse-scener: Jóhanna & manden"]
  },
  {
    id: "2025-11-07",
    dateISO: "2025-11-07",
    dateLabel: "Fredag 7. nov.",
    title: "Chef-kontor",
    location: { name: "Studentaskúlin í Hoydølum" },
    calltimes: [
      { time: "10:00", group: "Props/Design", notes: "Indretning til kontor (Anna K. + aftale m. instr./prod.)" },
      { time: "13:00", group: "Crew", notes: "HPH, Thomas, Ronni, Anna K." },
      { time: "14:15", group: "Skuespillere + Make-up", notes: "Esther, Hans, Thora; Julia ordner make-up & kostume" },
      { time: "16:00", group: "ALLE", notes: "Optagelse starter" },
      { time: "18:00", group: "ALLE", notes: "Pause (sandwich)" },
      { time: "18:30", group: "ALLE", notes: "Optagelse fortsætter" },
      { time: "20:30", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [],
    scenes: ["Gang → råb ind; døråbning; chef + Holgar på kontoret"]
  },
  {
    id: "2025-11-08",
    dateISO: "2025-11-08",
    dateLabel: "Lørdag 8. nov.",
    title: "Kørerscener & parkering",
    location: { name: "Studentaskúlin í Hoydølum" },
    calltimes: [
      { time: "13:00", group: "Crew", notes: "HPH, Thomas, Ronni, Anna K." },
      { time: "13:15", group: "Skuespillere + Politi", notes: "Hans, Esther, Politibetjent 1 & 2; 13:15–14:15 Make-up" },
      { time: "14:15", group: "ALLE", notes: "Optagelse starter" },
      { time: "18:00", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [ { role: "Politi kontakt", name: "via Sissal" } ],
    scenes: ["Politi ved indgang (filmes først)", "Parkeringsdrama", "Kørsel på Færøerne"]
  },
  {
    id: "2025-11-22",
    dateISO: "2025-11-22",
    dateLabel: "Lørdag 22. nov.",
    title: "Terapilokale (Dag 3)",
    location: { name: "Aulan, Studentaskúlin í Hoydølum" },
    calltimes: [ { time: "Som 1. nov.", group: "Plan", notes: "Samme rytme (morgenmad 07:01, start 08:00)" } ],
    contacts: [],
    scenes: ["Terapisession 05 (Ruth monolog) – del 1"]
  },
  {
    id: "2025-11-23",
    dateISO: "2025-11-23",
    dateLabel: "Søndag 23. nov.",
    title: "Terapilokale (Dag 4)",
    location: { name: "Aulan, Studentaskúlin í Hoydølum" },
    calltimes: [ { time: "Som 22. nov.", group: "Plan", notes: "Fortsat" } ],
    contacts: [],
    scenes: ["Terapisession 05 – fortsat"]
  },
  {
    id: "2025-11-24",
    dateISO: "2025-11-24",
    dateLabel: "Mandag 24. nov.",
    title: "Flashback 3 – Kaffemaskine + advokat",
    location: { name: "Tjarnir – Presselogen / møderum" },
    calltimes: [
      { time: "14:00", group: "Film crew", notes: "Gør kaffescenen klar (HPH, Thomas, Michael, Anna K.)" },
      { time: "15:00", group: "Lyd/Stylist/Make-up", notes: "Ronni, Julia, Anna K." },
      { time: "15:00", group: "Skuespillere (kaffescene)", notes: "2 statister + Hjálmar Dam" },
      { time: "15:45", group: "ALLE", notes: "Optagelse af kaffe-scenen" },
      { time: "17:05", group: "ALLE", notes: "Pause (sandwich)" },
      { time: "17:15", group: "Crew", notes: "Opsætning advokat-scene" },
      { time: "17:30", group: "Skuespillere (advokat)", notes: "Astrið G., Tórur v. Áir + Hjálmar Dam; make-up" },
      { time: "19:00", group: "ALLE", notes: "Optagelse advokat-scene" },
      { time: "21:00", group: "ALLE", notes: "SLUT" }
    ],
    contacts: [],
    scenes: ["Kantine/kaffemaskine", "HR-møde: Høgni opsagt"]
  }
];

// ====== HELPERS ======
const daysContainer = document.getElementById('daysContainer');
const jumpTo = document.getElementById('jumpTo');
const monthFilter = document.getElementById('monthFilter');
const searchInput = document.getElementById('searchInput');
const personFilter = document.getElementById('personFilter');
const personHint = document.getElementById('personHint');

function formatDateISO(d){ const [y,m,day] = d.split('-'); return `${day}.${m}.${y}`; }
function esc(str){ return (str||'').replace(/[&<>]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s])); }

function highlight(text, needle){
  if(!needle) return esc(text);
  const re = new RegExp(`(${needle.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')})`,'gi');
  return esc(text).replace(re,'<mark>$1</mark>');
}

// Kontaktbog (alle navne – inkl. locations). Filtrerer pauser/møder fra.
function collectAllNames(){
  const set = new Set();
  scheduleData.forEach(d=>{
    // Alle contacts (inkl. location-ejere) i kontaktbogen
    (d.contacts||[]).forEach(c=>{ if(c.name) set.add(c.name.trim()); });
    // Navne i cast/statist-blokke
    (d.calltimes||[]).forEach(ct=>{
      const isCastBlock = /skuespiller|skodespill|cast|statist/i.test(ct.group||'');
      if(!isCastBlock) return;
      const m = (ct.notes||'').match(/[A-ZÆØÅÍÐÓÚÝÁÄÖËÏÜ][A-Za-zÀ-ÖØ-öø-ÿÆØÅæøåÍÐÓÚÝÁÄÖËÏÜ'.\- ]{1,40}/g);
      (m||[])
        .map(s=>s.trim())
        .filter(s=>/^[A-Za-zÀ-ÖØ-öø-ÿÆØÅæøåÍÐÓÚÝÁÄÖËÏÜ]/.test(s))
        .filter(s=>!/(ALLE|Pause|Morgenmad|Frokost|Optagelse|Opsætning|SLUT|Make\-up|kostume|kaffe|transport|scene|Plan|fri)/i.test(s))
        .forEach(n=>set.add(n));
    });
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'da'));
}

function buildRolodex(names){
  const grid = document.getElementById('rolodexGrid');
  grid.innerHTML = '';
  names.forEach(n=>{
    const div = document.createElement('div');
    div.className = 'p-3 rounded-xl border bg-white text-sm';
    div.textContent = n;
    grid.appendChild(div);
  });
}

// Day card
function createDayCard(day, person){
  const month = day.dateISO.slice(5,7);
  const searchBlob = [day.title, day.location?.name, day.location?.address, day.scenes?.join(' '),
    (day.contacts||[]).map(c=>`${c.role} ${c.name||''}`).join(' '),
    (day.calltimes||[]).map(ct=>`${ct.group} ${ct.notes||''}`).join(' ')
  ].join(' ').toLowerCase();

  const card = document.createElement('section');
  card.className = 'card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden';
  card.dataset.month = month;
  card.dataset.search = searchBlob;
  card.id = `day-${day.id}`;

  const hasPerson = person && searchBlob.includes(person.toLowerCase());

  card.innerHTML = `
    <div class="px-5 py-4 flex flex-wrap items-start gap-3 md:gap-4 border-b ${hasPerson? 'bg-amber-50' : 'bg-slate-50'}">
      <div class="shrink-0 w-16 h-16 rounded-xl bg-slate-900 text-white grid place-items-center">
        <div class="text-center leading-tight">
          <div class="text-2xl font-bold">${new Date(day.dateISO).getDate()}</div>
          <div class="text-[10px] uppercase tracking-wide">${new Date(day.dateISO).toLocaleString('da-DK',{month:'short'})}</div>
        </div>
      </div>
      <div class="min-w-0 grow">
        <h2 class="text-lg font-semibold">${highlight(day.title, person)}</h2>
        <div class="text-sm text-slate-600 flex flex-wrap items-center gap-x-3 gap-y-1 mt-1">
          <span>📍 <strong>${highlight(day.location?.name||'', person)}</strong>${day.location?.address?`, ${highlight(day.location.address, person)}`:''}</span>
          ${day.location?.map ? `<a class="inline-flex items-center gap-1 text-slate-700 underline decoration-dotted" href="${day.location.map}" target="_blank" rel="noreferrer">Vis på kort ↗</a>` : ''}
          <span>🗓 ${day.dateLabel} (${formatDateISO(day.dateISO)})</span>
        </div>
        ${hasPerson?`<div class="mt-2 inline-flex items-center gap-2 text-xs px-2 py-1 rounded-lg bg-amber-100 text-amber-900">Denne dag har poster for <strong>${esc(person)}</strong></div>`:''}
      </div>
      <div class="no-print"><button class="toggleBtn px-3 py-2 rounded-xl border text-sm">Åbn/Luk</button></div>
    </div>

    <div class="content grid md:grid-cols-3 gap-6 p-5">
      <div class="md:col-span-2">
        <h3 class="font-semibold mb-2">Mødetider</h3>
        <div class="space-y-2">
          ${(day.calltimes||[]).map(ct=>`
            <div class="flex items-start gap-3 ${person && (ct.notes||'').toLowerCase().includes(person.toLowerCase()) ? 'bg-amber-50 rounded-lg p-2 -m-2' : ''}">
              <div class="w-20 shrink-0 font-semibold">${esc(ct.time)}</div>
              <div>
                <div class="font-medium">${highlight(ct.group, person)}</div>
                ${ct.notes?`<div class="text-sm text-slate-600">${highlight(ct.notes, person)}</div>`:''}
              </div>
            </div>
          `).join('')}
        </div>

        ${day.scenes?.length ? `
        <h3 class="font-semibold mt-6 mb-2">Scener</h3>
        <ul class="list-disc pl-5 space-y-1 text-sm">${day.scenes.map(s=>`<li>${highlight(s, person)}</li>`).join('')}</ul>
        `:''}
      </div>

      <div>
        <h3 class="font-semibold mb-2">Kontakter (navne uden tlf/e-mail)</h3>
        <div class="space-y-2 text-sm">
          ${(day.contacts||[]).map(c=>`
            <div class="p-3 rounded-xl border">
              <div class="font-medium">${esc(c.role||'')}</div>
              <div>${highlight(c.name||'', person)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="bg-slate-100 px-5 py-3 text-xs text-slate-600">Call sheet · ${day.dateLabel} · ${esc(day.location?.name||'')}</div>
  `;

  const btn = card.querySelector('.toggleBtn');
  const content = card.querySelector('.content');
  content.style.display = 'none';
  btn.addEventListener('click', ()=>{ content.style.display = content.style.display === 'none' ? 'grid' : 'none'; });

  return card;
}

// Render
function render(){
  daysContainer.innerHTML='';
  const q = (searchInput.value||'').toLowerCase().trim();
  const mf = monthFilter.value;
  const person = personFilter.value;

  scheduleData
    .slice()
    .sort((a,b)=> a.dateISO.localeCompare(b.dateISO))
    .forEach(day=>{
      const card = createDayCard(day, person);
      const matchMonth = !mf || card.dataset.month === mf;
      const matchQuery = !q || card.dataset.search.includes(q);
      const matchPerson = !person || card.dataset.search.includes(person.toLowerCase());
      card.style.display = (matchMonth && matchQuery && matchPerson) ? '' : 'none';
      daysContainer.appendChild(card);
    });

  // Build jump list
  jumpTo.innerHTML = '<option value="">— Vælg dato —</option>' + scheduleData
    .slice().sort((a,b)=>a.dateISO.localeCompare(b.dateISO))
    .map(d=>`<option value="${d.id}">${d.dateLabel} (${formatDateISO(d.dateISO)})</option>`).join('');

  // Person hint
  const hint = personFilter.value;
  personHint.classList.toggle('hidden', !hint);
  personHint.querySelector('span').textContent = hint || '';
}

// Print helpers
function openForPrint(filterFn){
  document.querySelectorAll('.content').forEach(c=>c.style.display='grid');
  document.querySelectorAll('#daysContainer > section').forEach(card=>{
    card.classList.remove('print-break');
    const id = card.id.replace('day-','');
    const show = filterFn(id);
    card.style.display = show ? '' : 'none';
    if(show) card.classList.add('print-break');
  });
  window.print();
  render();
}

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// Buttons
const printTodayBtn = document.getElementById('printTodayBtn');
const printAllBtn = document.getElementById('printAllBtn');

printTodayBtn.addEventListener('click', ()=>{
  const t = todayISO();
  const ids = scheduleData.map(d=>d.dateISO);
  const hasToday = ids.includes(t);
  const person = personFilter.value.toLowerCase();
  openForPrint((id)=>{
    const d = scheduleData.find(x=>x.id===id);
    if(!d) return false;
    const blob = [d.title, d.location?.name, (d.scenes||[]).join(' '), (d.contacts||[]).map(c=>c.name).join(' '), (d.calltimes||[]).map(ct=>ct.notes||'').join(' ')].join(' ').toLowerCase();
    const isPersonDay = !person || blob.includes(person);
    if(!isPersonDay) return false;
    if(hasToday) return d.dateISO===t;
    const upcoming = scheduleData.filter(x=>x.dateISO>=t).sort((a,b)=>a.dateISO.localeCompare(b.dateISO))[0];
    return upcoming ? d.id===upcoming.id : false;
  });
});

printAllBtn.addEventListener('click', ()=>{
  const person = personFilter.value.toLowerCase();
  openForPrint((id)=>{
    if(!person) return true;
    const d = scheduleData.find(x=>x.id===id);
    if(!d) return false;
    const blob = [d.title, d.location?.name, (d.scenes||[]).join(' '), (d.contacts||[]).map(c=>c.name).join(' '), (d.calltimes||[]).map(ct=>ct.notes||'').join(' ')].join(' ').toLowerCase();
    return blob.includes(person);
  });
});

// Init selects (kun crew/skuespillere/statister – udeluk locations og “pauser”)
function initPersonFilter(){
  const names = (function(){
    const set = new Set();
    scheduleData.forEach(d=>{
      // Crew fra contacts – udeluk locations
      (d.contacts||[]).forEach(c=>{
        if(!c.name) return;
        if(/location/i.test(c.role||'')) return; // ekskludér location owners i personfilteret
        set.add(c.name.trim());
      });
      // Skuespillere/statister fra calltimes-blokke
      (d.calltimes||[]).forEach(ct=>{
        const isCastBlock = /skuespiller|skodespill|cast|statist|crew/i.test(ct.group||'');
        if(!isCastBlock) return;
        const m = (ct.notes||'').match(/[A-ZÆØÅÍÐÓÚÝÁÄÖËÏÜ][A-Za-zÀ-ÖØ-öø-ÿÆØÅæøåÍÐÓÚÝÁÄÖËÏÜ'.\- ]{1,40}/g);
        (m||[])
          .map(s=>s.trim())
          .filter(s=>!/(ALLE|Pause|Morgenmad|Frokost|Optagelse|Opsætning|SLUT|Make\-up|kostume|kaffe|transport|scene|Plan|fri)/i.test(s))
          .forEach(n=>set.add(n));
      });
    });
    return Array.from(set).sort((a,b)=>a.localeCompare(b,'da'));
  })();
  personFilter.innerHTML = '<option value="">Alle personer</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
}

function initRolodex(){
  buildRolodex(collectAllNames());
}

// Navigation + filters
jumpTo.addEventListener('change', (e)=>{
  const id = e.target.value;
  if(!id) return;
  const el = document.getElementById('day-'+id);
  if(el){
    window.scrollTo({ top: el.offsetTop - 80, behavior: 'smooth' });
    const content = el.querySelector('.content');
    if(content && content.style.display==='none'){ content.style.display='grid'; }
  }
});
searchInput.addEventListener('input', render);
monthFilter.addEventListener('change', render);
personFilter.addEventListener('change', render);

// Boot
initPersonFilter();
initRolodex();
render();
</script>
</body>
</html>
